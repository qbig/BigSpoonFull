{% extends "staff.html" %}

{% load staticfiles %}
{% load compress %}
{% load cache %}
{% block content %}
{% load menufilters %}
    <div class="help">
        <p><i class="icon-group"></i> <strong>Tables</strong> shows you a bird's-eye view of all your current tables' unpaid orders.</p>
    </div>
<div class="wrapper">

    <span id="pick-table">
        <label> View
        <select>
            <option value="All Tables">
            All Tables
            </option>
            {% for table in table_list %}
            <option value="{{table.name}}">
            {{table.name|capfirst}}
            </option>
            {% endfor %}
        </select> </label>
    </span>

    {% for table in table_list %}

    <div class="table">
        <div class="table_title">
            <h3>{{table.name|capfirst}}</h3>
            <input type="button" value="Change Table" data-dropdown="#dropdown-for-page" class="tableDropdown pageDropdownChangeTable" data-tableId="{{ table.id }}">
        </div>
        <div class="table_content" id="table-{{table.id}}">
        {% if table.meals.count > 0 %}
            {% for meal in table.meals.all %}
                {% if meal.status == 1 and meal.is_paid == False %} <!-- Show only inactive and unpaid orders -->
                <div class='active' id="card-{{meal.diner.id}}">
                    {% if meal.wait_time.0 >= meal.table.outlet.threshold %}
                    <span class="urgent time countdown" start={{meal.count_down_start}}>
                    {% else %}
                    <span class="early time countdown" start={{meal.count_down_start}}>
                    {% endif %}
                        <i class="icon-time"></i> waited {{meal.wait_time.0}}m, {{meal.wait_time.1}}s
                    </span>
                    <span class='user'>
                        <a class="user-profile-link" href="/staff/user/{{meal.diner.id}}"><img src="{{meal.diner.avatar_url}}" /></a>
                        <h4>{{ meal.diner.get_full_name }}</h4>
                    </span>
                    {% cache 300 "diner-table"|add:meal.diner_id %}
                    <span class="user-summary">
                    <p class='profile-tab'>{{ meal.diner.meals.count }} visits</p>
                    <p class='profile-tab'>${{ meal.diner.get_average_spending }} ave</p>
                    <a href="/staff/user/{{meal.diner.id}}" class='view-profile full'><i class="icon-user"></i> Profile</a>
                    </span>
                    {% endcache %}
                    <ul class="order">
                        {% if meal.note %}
                            <li>
                                {{meal.note}}
                            </li>
                        {% endif %}

                        {% if meal.orders.count > 0 %}
                            {% for order in meal.orders.select_related %}
                            <li id="order-container-{{order.id}}">
                                <em class='quantity'>{{order.quantity}}x</em>
                                <p>{{order.dish.name}}</p>
                                
                                <a class='popup-modal cancel_order_icon_btn' data-orderId="{{order.id}}" href="#test-modal" onclick="setOrderToReduce(this);"><i class="icon-remove-sign icon-2" ></i></a>
                                <!--{% if order.dish.pos %}
                                <em class='pos'>{{order.dish.pos}}</em>
                                {% endif %}    -->
                            </li>
                                {% if order.note %}
                                    <li> note: {{order.note}}</li>
                                {% endif%}
                            {% endfor %}
                        {% else %}
                            <li class="no-order">No orders yet.</li>
                        {% endif %}
                        <li class="end">
                            --- end ---
                        </li>
                    </ul>

                    <a class="closebill ack-button" rel="bill" model="meal" id={{meal.id}}><i class="icon-money"></i> Close Bill</a>

                </div> <!-- end of class="active" -->
                {% endif %}
            {% endfor %}
        {% endif %}
        </div> <!-- end of <div class="table_content"> -->
        </div> <!-- end of <div class="table"> -->
        {% endfor %}
    </div> <!-- end of <div class="wrapper"> -->

    <div id="dropdown-for-page" class="dropdown dropdown-tip">
        <ul class="dropdown-menu">
            {% for table in table_list %}
            <li><a data-toTableId="{{table.id}}" class="targetTable">
            to table {{table.name|capfirst}}
            </a></li>
            {% endfor %}
        </ul>
    </div>
    <div id="dropdown-for-categories" class="dropdown dropdown-tip">
        <ul class="dropdown-menu">
            {% for category in categories %}
            <li><a data-categoryId="{{category.id}}" class="targetCategory" onclick="chooseCategory(this);">
            {{category.name|capfirst}}
            </a></li>
            {% endfor %}
        </ul>
    </div>

    {% for category in categories %}
    <div id="dropdown-for-dish-category-{{category.id}}" class="dropdown dropdown-tip">
        <ul class="dropdown-menu">     
        {% for dish in dishes|key:category.id %}
               
            <li><a data-dishId="{{dish.id}}" class="targetDish" onclick="chooseDish(this);">
            {{dish.name|capfirst}}
            </a></li>                    
        {% endfor %}
        </ul>
    </div>                    
    {% endfor %}
    
    <div id="test-modal" class="mfp-hide wrapper-no-bg white-popup">
        <h1>Modify this order?</h1>
        <p>You are going to reduce the quantity of this dish by 1 from this order.</p>

        <a class="popup-button popup-modal-dismiss" >Dismiss</a>
        <a class="popup-button popup-modal-ok" >Yes</a>
    </div>
{% endblock content %}

